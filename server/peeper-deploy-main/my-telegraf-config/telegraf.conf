# ===================================================================
# Глобальные настройки Telegraf
# ===================================================================
# Секция, определяющая общее поведение агента Telegraf.
[agent]
  # Как часто собирать метрики со ВСЕХ плагинов ввода.
  interval = "10s"
  # Выравнивать интервалы сбора до круглых значений (например, :00, :10, :20 секунд).
  round_interval = true
  # Использовать значение переменной окружения DOCKER_HOST как метку 'host' для всех метрик.
  hostname = "${DOCKER_HOST}"

# ===================================================================
# ВЫВОД: Куда отправлять метрики (в VictoriaMetrics)
# ===================================================================
# Секция, описывающая, куда Telegraf будет отправлять собранные данные.
[[outputs.http]]
  # Сетевой адрес, куда отправлять POST-запросы с метриками.
  # Значения ${AGENT_HOST} и ${AGENT_PORT} берутся из переменных окружения.
  url = "http://${AGENT_HOST}:${AGENT_PORT}/api/v1/write"
  # Формат, в который нужно упаковать данные перед отправкой.
  data_format = "prometheusremotewrite"
  # Дополнительные HTTP-заголовки, необходимые для этого формата.
  [outputs.http.headers]
    # Указываем, что в теле запроса находятся бинарные данные Protobuf.
    Content-Type = "application/x-protobuf"
    # Указываем, что тело запроса сжато с помощью алгоритма Snappy.
    Content-Encoding = "snappy"
    # Версия протокола (необязательно, но хорошая практика).
    X-Prometheus-Remote-Write-Version = "0.1.0"

# ===================================================================
# ВВОД: Что собирать
# ===================================================================

# --- Метрики Хоста (Linux) ---
# Секция для сбора метрик загрузки CPU.
[[inputs.cpu]]
  # Собирать статистику по каждому ядру CPU отдельно.
  percpu = true
  # Собирать общую статистику по всей системе.
  totalcpu = true
# Секция для сбора метрик об использовании дисковых разделов.
[[inputs.disk]]
  # Игнорировать временные и виртуальные файловые системы.
  ignore_fs = ["tmpfs", "devtmpfs", "overlay", "squashfs"]
# Секция для сбора сетевой статистики из /proc/net/netstat и /proc/net/snmp.
[[inputs.nstat]]
# Секция для сбора статистики дискового ввода-вывода (IO).
[[inputs.diskio]]
# Секция для сбора статистики по использованию оперативной памяти.
[[inputs.mem]]
# Секция для сбора статистики по сетевым интерфейсам (трафик, ошибки и т.д.).
[[inputs.net]]
# Секция для сбора статистики по запущенным процессам (общее число, спящие, зомби и т.д.).
[[inputs.processes]]
# Секция для сбора статистики по использованию swap-раздела.
[[inputs.swap]]
# Секция для сбора общей системной информации (загрузка, количество пользователей, время работы).
[[inputs.system]]
  # Не собирать поле 'uptime_format', так как оно текстовое и несовместимо с Prometheus.
  fielddrop = ["uptime_format"]
  
# --- Метрики Docker ---
# Секция для сбора метрик о работающих Docker-контейнерах.
[[inputs.docker]]
  # Путь к сокету Docker, через который Telegraf будет общаться с Docker API.
  endpoint = "unix://${DOCKER_SOCKET}"
  # Собирать метрики только с контейнеров в состоянии "running".
  container_state_include = ["running"]
  # Не добавлять Docker-метки (labels) контейнеров в качестве меток Telegraf.
  docker_label_exclude = ["*"]
  # Не собирать поля 'container_id' и 'health_status', чтобы уменьшить объем данных.
  fielddrop = ["container_id", "health_status"]
