# Peeper

## Документация

Внутренняя техническая документация:
https://intdocs.eltex.loc/display/WIFI/Peeper

Документация для клиента: < В работе >

## Краткое описание

Peeper - система мониторинга Eltex, созданная на базе OpenSource продуктов, которая предназначена для мониторинга
         всех программных продуктов Eltex и окружающей их инфраструктуры (Linux, Databases).

На данный момент Peeper поддерживает мониторинг:
- Linux
- Softswitch

### Структура

Решение состоит из 2 частей:

client - устанавливается на хосте, где работает приложение, с которого собираются метрики мониторинга. Базово состоит
         из сервиса telegraf, который собирает всевозможные метрики с хоста и приложений с помощью различных inputs
         плагинов и отправляет их по http в сторону центрального сервера

server - устанавливается на центральном хосте, куда все метрики отправляются с клиентских хостов,
         хранятся и визуализируются. Состоит из серверного telegraf, который принимает все метрики от клиентских хостов
         по HTTP, Prometheus, который забирает метрики из Telegraf и хранит их, Grafana, которая визуализирует метрики
         в преднастроенных дашбордах и отправляет алерты с помощью встроенного Alert-manager.

## Запуск

На хостах должны быть установлены docker и docker compose: https://docs.docker.com/engine/install/ubuntu/

Скопировать папку server на серверный хост и client на клиентский хост

Скорректировать .env :

    server - указать токен бота, ID чата Telegram, IP или домен сервера с Grafana

    client - указать адрес server хоста и уникальный строковый Hostname, идентифицирующий
             клиентский хост

Выполнить  docker compose up -d  на хосте с client и хосте с server

## Старая документация мониторинга ECCM

Текущая директория содержит конфигурационные файлы для настроек стека приложений для мониторинга инфраструктуры ЕССМ.

Стек мониторинга описан в файле `../docker-compose.monitoring.yml` и содержит следующие приложения:

* Prometheus - база данных для хранения метрик сервисов
* Grafana - приложение для визуализации собираемых метрик
* Node Exporter - приложение для сбора метрик linux-хоста
* Pgwatch2 - стек-приложений для сбора метрик Postgres. Состоит из следующих сервисов:
  * Демон-коллектор (`pw2-daemon`) - осуществляет сбор метрик БД. Работает в режиме file-based конфигурирования.
  * База данных для хранения метрик (`pw2-postgres`)
  * Сервис-настройщик БД для хранения метрик (`pw2-bootstrapper`)
  * Сервис-настройщик БД для мониторинга (`db-bootstrapper`). Осуществляет подготовку целевой базы данных к мониторингу

# Запуск мониторинга

Запуск сервисов мониторинга осуществляется с помощью скрипта-инсталятора путем добавления ключа `-m/--metrics`:

```
./compose-tools.sh --start SERVER_IP -m
```

Или через встроенные инструменты Docker Compose:

```
POSTGRES_HOST=SERVER_IP docker compose -f eccm/docker-compose.monitoring.yml up -d
```

# Настройка Alerting в Grafana

1. Создать **Contact points**:
   1. Перейти в 'Home > Alerting > Contact points'
   2. Нажать 'Add contact point'
   3. Заполнить необходимые поля
2. Настроить **Notification policies**
   1. Перейти в 'Home > Alerting > Notification policies'
   2. Перейти в диалог редактирования **Default policy** (*Default policy > Edit*)
   3. В поле "*Default contact point*" выбрать *Contact points* из п.1 и нажать "*Update default police*"

При создании событий (alert) на созданный *Contact points* будут приходить уведомления.
